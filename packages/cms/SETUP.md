# CMS Setup Guide

This guide explains how to set up and run the Payload CMS for the first time.

## Quick Start

```bash
# From repository root
npm install
npm run dev --workspace cms
```

The dev script automatically:
1. Generates the `importMap.js` file required by Payload
2. Runs any pending database migrations
3. Starts the Next.js development server

## First Time Setup

1. **Install dependencies:**
   ```bash
   npm install
   ```

2. **Start the CMS:**
   ```bash
   npm run dev --workspace cms
   ```

3. **Create your first admin user:**
   - Navigate to http://localhost:3000/admin
   - You'll be redirected to the "Create first user" page
   - Enter your email and password
   - Click "Create"

4. **You're ready!** You can now manage content through the admin panel.

## What Gets Auto-Generated

### importMap.js
- Location: `src/app/(payload)/admin/importMap.js`
- Purpose: Maps Payload components for Next.js
- Generated by: `payload generate:importmap`
- **Note:** This file is gitignored and regenerated automatically

### Database Migrations
- Location: `src/migrations/`
- Purpose: Create and update database schema
- Run by: `payload migrate`
- **Note:** Migrations are tracked in the database

## Manual Commands

If you need to run these steps manually:

```bash
# Generate importMap
npm run generate:importmap --workspace cms

# Run migrations
npm run payload migrate --workspace cms

# Start dev server
npm run dev --workspace cms
```

## Troubleshooting

### Error: "Module not found: Can't resolve '../importMap.js'"
**Solution:** Run `npm run generate:importmap --workspace cms`

### Error: "no such table: users"
**Solution:** Run `npm run payload migrate --workspace cms`

### Admin panel won't load
1. Check that the server is running on port 3000
2. Verify importMap.js exists: `ls packages/cms/src/app/(payload)/admin/importMap.js`
3. Check migrations ran: `npm run payload migrate:status --workspace cms`
4. Look for errors in the terminal

## Production Build

```bash
# Build for production
npm run build --workspace cms

# Start production server
npm run start --workspace cms
```

The build script automatically generates the importMap before building.

## Database

- Uses SQLite stored in `data.db`
- Located in the cms package directory
- Created automatically on first run
- Back up this file to preserve your data

## Environment Variables

See `.env.example` for required environment variables:
- `PAYLOAD_SECRET` - Secret key for JWT tokens (required)
- `DATABASE_URL` - Path to SQLite database (default: file:./data.db)
- `PAYLOAD_PUBLIC_SERVER_URL` - Public URL for the CMS
- `PORT` - Server port (default: 3000)

## Next Steps

1. Log in to the admin panel
2. Import existing content (if migrating from MDX)
3. Start managing your psychoactives, combos, and risks
4. See [PAYLOAD_ADMIN.md](./PAYLOAD_ADMIN.md) for admin panel usage

## Common Tasks

### Check migration status
```bash
npm run payload migrate:status --workspace cms
```

### Create a new migration
```bash
npm run payload migrate:create <name> --workspace cms
```

### Generate TypeScript types
```bash
npm run generate:types --workspace cms
```

## Support

- [Payload CMS Documentation](https://payloadcms.com/docs)
- [Admin Guide](./ADMIN_GUIDE.md)
- [API Documentation](./API_EDITING_GUIDE.md)
